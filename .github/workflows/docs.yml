name: docs

on:
  push: {}

jobs:
  build:
    if: ${{ github.ref_name == github.event.repository.default_branch }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python 3.x
      uses: actions/setup-python@v6
      with:
        python-version: '3.13'
    # - name: Install sndfile library # for librose, see https://github.com/deepcharles/ruptures/pull/121
    #   run: |
    #     sudo apt-get install libsndfile1-dev
    - name: Install ruptures and dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install \
          mkdocs \
          mkdocs-material \
          mkdocstrings[python] \
          mknotebooks \
          mkdocs-macros-plugin \
          mkdocs-section-index # .[docs]
    # - name: Run notebooks
    #   run: |
    #     find ./docs -name '*.ipynb' | xargs -P 3 -I % jupyter nbconvert --inplace --to notebook --ExecutePreprocessor.kernel_name=python --execute %
    - name: Build documentation
      env:
        REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        REPO_NAME: ${{ github.repository }}
        REPO_SHORTNAME: ${{ github.event.repository.name }}
      run: |
        grep -v FOR_README_ONLY README.md >> docs/index.md
        mkdocs build
    - uses: actions/upload-pages-artifact@v3
      with:
        path: site/
  deploy:
    permissions:
      pages: write
      id-token: write
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/deploy-pages@v4
